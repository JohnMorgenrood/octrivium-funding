generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  INVESTOR
  BUSINESS
  ADMIN
}

enum KYCStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum DealStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  FUNDED
  REPAYING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INVESTMENT
  REVENUE_PAYOUT
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          UserRole  @default(INVESTOR)
  firstName     String
  lastName      String
  phone         String?
  idNumber      String?   @unique
  avatar        String?
  emailVerified DateTime?
  kycStatus     KYCStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  wallet        Wallet?
  investments   Investment[]
  businesses    Business[]
  kycDocuments  KYCDocument[]
  notifications Notification[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@index([kycStatus])
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique
  balance        Decimal  @default(0) @db.Decimal(15, 2)
  availableBalance Decimal @default(0) @db.Decimal(15, 2)
  lockedBalance  Decimal  @default(0) @db.Decimal(15, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([userId])
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(15, 2)
  fee             Decimal           @default(0) @db.Decimal(15, 2)
  netAmount       Decimal           @db.Decimal(15, 2)
  currency        String            @default("ZAR")
  reference       String?           @unique
  description     String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  wallet          Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  investment      Investment?       @relation(fields: [investmentId], references: [id])
  investmentId    String?
  revenuePayout   RevenuePayout?    @relation(fields: [revenuePayoutId], references: [id])
  revenuePayoutId String?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Business {
  id                  String     @id @default(uuid())
  userId              String
  registrationNumber  String     @unique
  tradingName         String
  legalName           String
  industry            String
  description         String     @db.Text
  website             String?
  founderName         String?
  founderTitle        String?    // CEO, Founder, Managing Director, etc.
  founderBio          String?    @db.Text
  teamSize            Int?
  yearFounded         Int?
  companyStory        String?    @db.Text
  address             String
  city                String
  province            String
  postalCode          String
  logo                String?
  bankName            String?
  bankAccountNumber   String?
  bankBranchCode      String?
  verified            Boolean    @default(false)
  verifiedAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals               Deal[]
  documents           BusinessDocument[]

  @@index([userId])
  @@index([registrationNumber])
}

model Deal {
  id                    String     @id @default(uuid())
  businessId            String
  title                 String
  description           String     @db.Text
  fundingGoal           Decimal    @db.Decimal(15, 2)
  currentFunding        Decimal    @default(0) @db.Decimal(15, 2)
  minInvestment         Decimal    @default(100) @db.Decimal(15, 2)
  maxInvestment         Decimal?   @db.Decimal(15, 2)
  revenueSharePercentage Decimal   @db.Decimal(5, 2) // e.g., 5.00 for 5%
  repaymentCap          Decimal    @db.Decimal(5, 2) // e.g., 1.70 for 1.7x
  status                DealStatus @default(DRAFT)
  riskRating            Int        @default(5) // 1-10 scale
  fundingDeadline       DateTime
  startDate             DateTime?
  endDate               DateTime?
  projectedMonthlyRevenue Decimal? @db.Decimal(15, 2)
  actualMonthlyRevenue  Decimal    @default(0) @db.Decimal(15, 2)
  totalRepaid           Decimal    @default(0) @db.Decimal(15, 2)
  investorCount         Int        @default(0)
  featuredImage         String?
  documents             Json?
  termsAndConditions    String     @db.Text
  adminNotes            String?    @db.Text
  approvedAt            DateTime?
  approvedBy            String?
  
  // Premium Listing Features
  isFeatured            Boolean    @default(false) // Featured badge on card
  isTopListing          Boolean    @default(false) // Top of homepage spot
  isSponsored           Boolean    @default(false) // Sponsored category placement
  isPrioritySearch      Boolean    @default(false) // Priority in search results
  isNewsletterFeatured  Boolean    @default(false) // Featured in investor newsletter
  isSocialBoosted       Boolean    @default(false) // Featured on social media
  isPriorityReview      Boolean    @default(false) // Fast-track approval
  premiumExpiresAt      DateTime?  // When premium features expire
  premiumNotes          String?    @db.Text // Admin notes about premium features
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  // Relations
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  investments           Investment[]
  revenueReports        RevenueReport[]
  revenuePayouts        RevenuePayout[]

  @@index([businessId])
  @@index([status])
  @@index([fundingDeadline])
}

model Investment {
  id                String    @id @default(uuid())
  userId            String
  dealId            String
  amount            Decimal   @db.Decimal(15, 2)
  sharePercentage   Decimal   @db.Decimal(10, 6) // Investor's % of total deal
  totalReceived     Decimal   @default(0) @db.Decimal(15, 2)
  expectedReturn    Decimal   @db.Decimal(15, 2) // amount * repaymentCap
  status            String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  agreementSigned   Boolean   @default(false)
  agreementUrl      String?
  signedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  payouts           InvestorPayout[]

  @@index([userId])
  @@index([dealId])
  @@index([status])
}

model RevenueReport {
  id                String    @id @default(uuid())
  dealId            String
  reportingMonth    DateTime  // First day of the month
  revenue           Decimal   @db.Decimal(15, 2)
  shareableAmount   Decimal   @db.Decimal(15, 2) // revenue * revenueSharePercentage
  supportingDocs    Json?
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  payout            RevenuePayout?

  @@unique([dealId, reportingMonth])
  @@index([dealId])
  @@index([reportingMonth])
}

model RevenuePayout {
  id                String    @id @default(uuid())
  dealId            String
  revenueReportId   String    @unique
  totalAmount       Decimal   @db.Decimal(15, 2)
  platformFee       Decimal   @db.Decimal(15, 2)
  netAmount         Decimal   @db.Decimal(15, 2)
  payoutMonth       DateTime
  status            String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  revenueReport     RevenueReport @relation(fields: [revenueReportId], references: [id], onDelete: Cascade)
  investorPayouts   InvestorPayout[]
  transactions      Transaction[]

  @@index([dealId])
  @@index([status])
  @@index([payoutMonth])
}

model InvestorPayout {
  id                String    @id @default(uuid())
  investmentId      String
  revenuePayoutId   String
  amount            Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  investment        Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  revenuePayout     RevenuePayout @relation(fields: [revenuePayoutId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([revenuePayoutId])
}

model KYCDocument {
  id            String    @id @default(uuid())
  userId        String
  documentType  String    // ID_DOCUMENT, PROOF_OF_ADDRESS, BANK_STATEMENT, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String?  @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
}

model BusinessDocument {
  id            String    @id @default(uuid())
  businessId    String
  documentType  String    // REGISTRATION_CERT, TAX_CLEARANCE, FINANCIAL_STATEMENTS, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String? @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([documentType])
}

model Notification {
  id            String    @id @default(uuid())
  userId        String
  type          String    // EMAIL, IN_APP, SMS
  category      String    // INVESTMENT, PAYOUT, KYC, DEAL_UPDATE, etc.
  title         String
  message       String    @db.Text
  metadata      Json?
  read          Boolean   @default(false)
  readAt        DateTime?
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  action        String    // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity        String    // USER, DEAL, INVESTMENT, etc.
  entityId      String?
  changes       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  // Relations
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}
