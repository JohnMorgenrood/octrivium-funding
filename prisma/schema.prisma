generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  INVESTOR
  BUSINESS
  ADMIN
}

enum KYCStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum DealStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  FUNDED
  REPAYING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INVESTMENT
  REVENUE_PAYOUT
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RevenueSourceType {
  BANK_FEED      // Stitch bank integration
  ACCOUNTING     // Sage, Xero, QuickBooks, Zoho
  MANUAL_UPLOAD  // Manual statement upload
}

enum AccountingProvider {
  SAGE_BUSINESS_CLOUD
  XERO
  QUICKBOOKS_ONLINE
  ZOHO_BOOKS
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FLAGGED
  FAILED
  DISCONNECTED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          UserRole  @default(INVESTOR)
  firstName     String
  lastName      String
  phone         String?
  idNumber      String?   @unique
  avatar        String?
  emailVerified DateTime?
  kycStatus     KYCStatus @default(PENDING)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  wallet        Wallet?
  investments   Investment[]
  businesses    Business[]
  kycDocuments  KYCDocument[]
  notifications Notification[]
  auditLogs     AuditLog[]
  bankCards     BankCard[]

  @@index([email])
  @@index([role])
  @@index([kycStatus])
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique
  balance        Decimal  @default(0) @db.Decimal(15, 2)
  availableBalance Decimal @default(0) @db.Decimal(15, 2)
  lockedBalance  Decimal  @default(0) @db.Decimal(15, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([userId])
}

model BankCard {
  id             String   @id @default(uuid())
  userId         String
  bankName       String   // Capitec, FNB, Nedbank, Standard Bank, Discovery, Custom
  cardHolderName String
  cardNumber     String   // Last 4 digits only for security
  expiryMonth    String
  expiryYear     String
  cardType       String   // Visa, Mastercard, etc.
  isDefault      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(15, 2)
  fee             Decimal           @default(0) @db.Decimal(15, 2)
  netAmount       Decimal           @db.Decimal(15, 2)
  currency        String            @default("ZAR")
  reference       String?           @unique
  description     String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  wallet          Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  investment      Investment?       @relation(fields: [investmentId], references: [id])
  investmentId    String?
  revenuePayout   RevenuePayout?    @relation(fields: [revenuePayoutId], references: [id])
  revenuePayoutId String?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Business {
  id                  String     @id @default(uuid())
  userId              String
  registrationNumber  String     @unique
  tradingName         String
  legalName           String
  industry            String
  description         String     @db.Text
  website             String?
  founderName         String?
  founderTitle        String?    // CEO, Founder, Managing Director, etc.
  founderBio          String?    @db.Text
  teamSize            Int?
  yearFounded         Int?
  companyStory        String?    @db.Text
  address             String
  city                String
  province            String
  postalCode          String
  logo                String?
  bankName            String?
  bankAccountNumber   String?
  bankBranchCode      String?
  verified            Boolean    @default(false)
  verifiedAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals               Deal[]
  documents           BusinessDocument[]
  revenueConnections  RevenueConnection[]

  @@index([userId])
  @@index([registrationNumber])
}

model Deal {
  id                    String     @id @default(uuid())
  businessId            String
  title                 String
  description           String     @db.Text
  imageUrl              String?    // Deal card image
  fundingGoal           Decimal    @db.Decimal(15, 2)
  currentFunding        Decimal    @default(0) @db.Decimal(15, 2)
  minInvestment         Decimal    @default(100) @db.Decimal(15, 2)
  maxInvestment         Decimal?   @db.Decimal(15, 2)
  revenueSharePercentage Decimal   @db.Decimal(5, 2) // e.g., 5.00 for 5%
  repaymentCap          Decimal    @db.Decimal(5, 2) // e.g., 1.70 for 1.7x
  status                DealStatus @default(DRAFT)
  riskRating            Int        @default(5) // 1-10 scale
  fundingDeadline       DateTime
  startDate             DateTime?
  endDate               DateTime?
  projectedMonthlyRevenue Decimal? @db.Decimal(15, 2)
  actualMonthlyRevenue  Decimal    @default(0) @db.Decimal(15, 2)
  totalRepaid           Decimal    @default(0) @db.Decimal(15, 2)
  investorCount         Int        @default(0)
  featuredImage         String?
  documents             Json?
  termsAndConditions    String     @db.Text
  adminNotes            String?    @db.Text
  approvedAt            DateTime?
  approvedBy            String?
  
  // Premium Listing Features
  isFeatured            Boolean    @default(false) // Featured badge on card
  isTopListing          Boolean    @default(false) // Top of homepage spot
  isSponsored           Boolean    @default(false) // Sponsored category placement
  isPrioritySearch      Boolean    @default(false) // Priority in search results
  isNewsletterFeatured  Boolean    @default(false) // Featured in investor newsletter
  isSocialBoosted       Boolean    @default(false) // Featured on social media
  isPriorityReview      Boolean    @default(false) // Fast-track approval
  premiumExpiresAt      DateTime?  // When premium features expire
  premiumNotes          String?    @db.Text // Admin notes about premium features
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  // Relations
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  investments           Investment[]
  revenueReports        RevenueReport[]
  revenuePayouts        RevenuePayout[]
  revenueRecords        RevenueRecord[]

  @@index([businessId])
  @@index([status])
  @@index([fundingDeadline])
}

model Investment {
  id                String    @id @default(uuid())
  userId            String
  dealId            String
  amount            Decimal   @db.Decimal(15, 2)
  sharePercentage   Decimal   @db.Decimal(10, 6) // Investor's % of total deal
  totalReceived     Decimal   @default(0) @db.Decimal(15, 2)
  expectedReturn    Decimal   @db.Decimal(15, 2) // amount * repaymentCap
  status            String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  agreementSigned   Boolean   @default(false)
  agreementUrl      String?
  signedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  payouts           InvestorPayout[]

  @@index([userId])
  @@index([dealId])
  @@index([status])
}

model RevenueReport {
  id                String    @id @default(uuid())
  dealId            String
  reportingMonth    DateTime  // First day of the month
  revenue           Decimal   @db.Decimal(15, 2)
  shareableAmount   Decimal   @db.Decimal(15, 2) // revenue * revenueSharePercentage
  supportingDocs    Json?
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  payout            RevenuePayout?

  @@unique([dealId, reportingMonth])
  @@index([dealId])
  @@index([reportingMonth])
}

model RevenuePayout {
  id                String    @id @default(uuid())
  dealId            String
  revenueReportId   String    @unique
  totalAmount       Decimal   @db.Decimal(15, 2)
  platformFee       Decimal   @db.Decimal(15, 2)
  netAmount         Decimal   @db.Decimal(15, 2)
  payoutMonth       DateTime
  status            String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  revenueReport     RevenueReport @relation(fields: [revenueReportId], references: [id], onDelete: Cascade)
  investorPayouts   InvestorPayout[]
  transactions      Transaction[]

  @@index([dealId])
  @@index([status])
  @@index([payoutMonth])
}

model InvestorPayout {
  id                String    @id @default(uuid())
  investmentId      String
  revenuePayoutId   String
  amount            Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  investment        Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  revenuePayout     RevenuePayout @relation(fields: [revenuePayoutId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([revenuePayoutId])
}

model KYCDocument {
  id            String    @id @default(uuid())
  userId        String
  documentType  String    // ID_DOCUMENT, PROOF_OF_ADDRESS, BANK_STATEMENT, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String?  @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
}

model BusinessDocument {
  id            String    @id @default(uuid())
  businessId    String
  documentType  String    // REGISTRATION_CERT, TAX_CLEARANCE, FINANCIAL_STATEMENTS, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String? @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([documentType])
}

model Notification {
  id            String    @id @default(uuid())
  userId        String
  type          String    // EMAIL, IN_APP, SMS
  category      String    // INVESTMENT, PAYOUT, KYC, DEAL_UPDATE, etc.
  title         String
  message       String    @db.Text
  metadata      Json?
  read          Boolean   @default(false)
  readAt        DateTime?
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  action        String    // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity        String    // USER, DEAL, INVESTMENT, etc.
  entityId      String?
  changes       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  // Relations
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

// Revenue Verification System

model RevenueConnection {
  id                String              @id @default(uuid())
  businessId        String
  sourceType        RevenueSourceType
  provider          AccountingProvider? // Only for ACCOUNTING type
  
  // Connection Status
  isConnected       Boolean             @default(false)
  status            VerificationStatus  @default(PENDING)
  lastSyncAt        DateTime?
  lastSyncStatus    String?             // SUCCESS, FAILED, PARTIAL
  nextSyncAt        DateTime?
  
  // OAuth Tokens (encrypted)
  accessToken       String?             @db.Text
  refreshToken      String?             @db.Text
  tokenExpiresAt    DateTime?
  
  // Connection Metadata
  accountId         String?             // External account/org ID
  accountName       String?             // Bank name or accounting org name
  metadata          Json?               // Additional provider-specific data
  
  // Error Tracking
  lastError         String?             @db.Text
  errorCount        Int                 @default(0)
  
  connectedAt       DateTime?
  disconnectedAt    DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  business          Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bankAccounts      BankAccount[]
  revenueRecords    RevenueRecord[]
  verificationLogs  VerificationLog[]

  @@unique([businessId, sourceType])
  @@index([businessId])
  @@index([sourceType])
  @@index([status])
  @@index([lastSyncAt])
}

model BankAccount {
  id                  String            @id @default(uuid())
  connectionId        String
  
  // Bank Account Details
  accountId           String            // External bank account ID from Stitch
  accountName         String
  accountNumber       String?
  accountType         String?           // CURRENT, SAVINGS, CREDIT_CARD
  bankName            String
  currency            String            @default("ZAR")
  
  // Balance Info
  currentBalance      Decimal?          @db.Decimal(15, 2)
  availableBalance    Decimal?          @db.Decimal(15, 2)
  
  // Status
  isActive            Boolean           @default(true)
  lastTransactionDate DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  connection          RevenueConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactions        BankTransaction[]

  @@unique([connectionId, accountId])
  @@index([connectionId])
  @@index([accountId])
}

model BankTransaction {
  id                String      @id @default(uuid())
  bankAccountId     String
  
  // Transaction Details
  transactionId     String      // External transaction ID
  date              DateTime
  description       String
  amount            Decimal     @db.Decimal(15, 2)
  balance           Decimal?    @db.Decimal(15, 2)
  category          String?
  reference         String?
  
  // Classification
  isRevenue         Boolean     @default(false)
  isExpense         Boolean     @default(false)
  isTransfer        Boolean     @default(false)
  
  metadata          Json?
  createdAt         DateTime    @default(now())

  // Relations
  bankAccount       BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@unique([bankAccountId, transactionId])
  @@index([bankAccountId])
  @@index([date])
  @@index([isRevenue])
}

model RevenueRecord {
  id                  String              @id @default(uuid())
  dealId              String
  connectionId        String
  
  // Period
  month               DateTime            // First day of month
  year                Int
  
  // Revenue Data
  totalRevenue        Decimal             @db.Decimal(15, 2)
  verifiedRevenue     Decimal?            @db.Decimal(15, 2)
  revenueShareAmount  Decimal             @db.Decimal(15, 2) // Amount owed to investors
  
  // Source Info
  sourceType          RevenueSourceType
  sourceData          Json?               // Raw data from source
  
  // Verification
  status              VerificationStatus  @default(PENDING)
  verifiedAt          DateTime?
  verifiedBy          String?             // Admin user ID
  
  // Discrepancy Detection
  hasDiscrepancy      Boolean             @default(false)
  discrepancyAmount   Decimal?            @db.Decimal(15, 2)
  discrepancyNotes    String?             @db.Text
  
  // Payout Status
  payoutScheduled     Boolean             @default(false)
  payoutCompletedAt   DateTime?
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  deal                Deal                @relation(fields: [dealId], references: [id], onDelete: Cascade)
  connection          RevenueConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([dealId, connectionId, month])
  @@index([dealId])
  @@index([connectionId])
  @@index([month])
  @@index([status])
}

model VerificationLog {
  id                String            @id @default(uuid())
  connectionId      String
  
  // Verification Details
  verificationType  String            // BANK_SYNC, ACCOUNTING_SYNC, CROSS_REFERENCE, FRAUD_CHECK
  status            String            // SUCCESS, FAILED, WARNING
  
  // Data
  dataFetched       Json?
  discrepancies     Json?
  
  // Results
  message           String?           @db.Text
  errorDetails      String?           @db.Text
  
  // Metadata
  duration          Int?              // Sync duration in ms
  recordsProcessed  Int?
  recordsFailed     Int?
  
  createdAt         DateTime          @default(now())

  // Relations
  connection        RevenueConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([verificationType])
  @@index([status])
  @@index([createdAt])
}

model ManualUpload {
  id                String            @id @default(uuid())
  businessId        String
  dealId            String?
  
  // File Details
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  
  // Upload Type
  uploadType        String            // BANK_STATEMENT, ACCOUNTING_REPORT, INVOICE_EXPORT
  month             DateTime          // Period this upload covers
  
  // Extracted Data
  extractedRevenue  Decimal?          @db.Decimal(15, 2)
  extractedData     Json?
  
  // Verification
  status            VerificationStatus @default(PENDING)
  verifiedAt        DateTime?
  verifiedBy        String?
  rejectionReason   String?           @db.Text
  
  // Notes
  businessNotes     String?           @db.Text
  adminNotes        String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([businessId])
  @@index([dealId])
  @@index([month])
  @@index([status])
}

model PayoutSchedule {
  id                String            @id @default(uuid())
  dealId            String
  month             DateTime          // Payment month
  
  // Amounts
  totalRevenue      Decimal           @db.Decimal(15, 2)
  revenueShareAmount Decimal          @db.Decimal(15, 2)
  platformFee       Decimal           @db.Decimal(15, 2)
  netPayoutAmount   Decimal           @db.Decimal(15, 2)
  
  // Status
  status            String            @default("SCHEDULED") // SCHEDULED, PROCESSING, COMPLETED, FAILED, PAUSED
  scheduledDate     DateTime
  processedDate     DateTime?
  
  // Flags
  isPaused          Boolean           @default(false)
  pauseReason       String?           @db.Text
  
  // References
  revenueRecordIds  Json              // Array of RevenueRecord IDs used
  
  // Metadata
  investorCount     Int?
  metadata          Json?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([dealId, month])
  @@index([dealId])
  @@index([month])
  @@index([status])
  @@index([scheduledDate])
}
