generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  INVESTOR
  BUSINESS
  ADMIN
}

enum KYCStatus {
  NOT_SUBMITTED
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  VERIFIED
}

enum DealStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  FUNDED
  REPAYING
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  INVESTMENT
  REVENUE_PAYOUT
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum SubscriptionTier {
  FREE
  STARTER
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum RevenueSourceType {
  BANK_FEED      // Stitch bank integration
  ACCOUNTING     // Sage, Xero, QuickBooks, Zoho
  MANUAL_UPLOAD  // Manual statement upload
}

enum AccountingProvider {
  SAGE_BUSINESS_CLOUD
  XERO
  QUICKBOOKS_ONLINE
  ZOHO_BOOKS
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FLAGGED
  FAILED
  DISCONNECTED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  role          UserRole  @default(INVESTOR)
  firstName     String
  lastName      String
  phone         String?
  idNumber      String?   @unique
  avatar        String?
  companyLogo   String?
  companyName   String?
  companyEmail  String?   // Business email for invoices (different from login email)
  companyPhone  String?   // Business phone
  companyAddress String?  // Full business address
  companyCity   String?   // City
  companyPostalCode String? // Postal code
  companyCountry String?  // Country
  taxNumber     String?   // VAT/Tax registration number
  registrationNumber String? // Business registration number
  website       String?   // Company website
  emailVerified DateTime?
  kycStatus     KYCStatus @default(NOT_SUBMITTED)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Subscription fields
  subscriptionTier      SubscriptionTier     @default(FREE)
  subscriptionStatus    SubscriptionStatus   @default(ACTIVE)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  invoiceCount          Int                  @default(0) // Resets monthly for FREE/STARTER tiers
  lastInvoiceReset      DateTime?            // Track when we last reset the count
  teamMemberCount       Int                  @default(1) // Number of users in this company account
  companyOwnerId        String?              // If this is a team member, link to company owner
  companyOwner          User?                @relation("CompanyMembers", fields: [companyOwnerId], references: [id], onDelete: Cascade)
  teamMembers           User[]               @relation("CompanyMembers")

  // Bank details for invoices (EFT/Bank Transfer) - STARTER/BUSINESS ONLY
  bankName          String?
  bankAccountName   String?
  bankAccountNumber String?
  bankBranchCode    String?
  bankAccountType   String?  // Cheque, Savings, Business

  // Company's own Yoco keys (BUSINESS TIER ONLY) - if empty, uses platform Yoco
  yocoPublicKey     String?  // Their own pk_live_xxx or pk_test_xxx
  yocoSecretKey     String?  // Their own sk_live_xxx or sk_test_xxx

  // Notification preferences
  emailNotifications    Boolean @default(true)
  pushNotifications     Boolean @default(false)
  notificationPreferences Json? // { invoicePaid: true, invoiceOverdue: true, etc. }

  // Email Service fields
  emailPlanType         String  @default("FREE") // FREE, PRO, BUSINESS
  emailQuotaLimit       Int     @default(50) // Monthly send limit
  emailQuotaUsed        Int     @default(0) // Emails sent this month
  emailQuotaResetDate   DateTime? // When quota resets
  customEmailAddress    String? @unique // john@octrivium.co.za or support@octrivium.co.za
  companySubdomain      String? @unique // businessname (for email@businessname.octrivium.co.za)

  // Relations
  wallet        Wallet?
  investments   Investment[]
  businesses    Business[]
  kycDocuments  KYCDocument[]
  notifications Notification[]
  auditLogs     AuditLog[]
  bankCards     BankCard[]
  customers     Customer[]
  invoices      Invoice[]
  recurringInvoices RecurringInvoice[]
  expenses      Expense[]
  accountingTransactions AccountingTransaction[]
  chartOfAccounts ChartOfAccounts[]
  products      Product[]
  subscriptions Subscription[]
  sentEmails    Email[]  @relation("SentEmails")
  receivedEmails Email[] @relation("ReceivedEmails")

  @@index([email])
  @@index([role])
  @@index([kycStatus])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
}

model Wallet {
  id             String   @id @default(uuid())
  userId         String   @unique
  balance        Decimal  @default(0) @db.Decimal(15, 2)
  availableBalance Decimal @default(0) @db.Decimal(15, 2)
  lockedBalance  Decimal  @default(0) @db.Decimal(15, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@index([userId])
}

model BankCard {
  id             String   @id @default(uuid())
  userId         String
  bankName       String   // Capitec, FNB, Nedbank, Standard Bank, etc.
  accountHolder  String   // Account holder name
  accountNumber  String   // Bank account number
  accountType    String   // Cheque, Savings, Business
  branchCode     String   // Branch code for EFT
  branchName     String?  // Optional branch name
  isDefault      Boolean  @default(false)
  verified       Boolean  @default(false) // Admin can verify after first successful payment
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isDefault])
}

model Subscription {
  id              String             @id @default(uuid())
  userId          String
  tier            SubscriptionTier
  status          SubscriptionStatus @default(ACTIVE)
  amount          Decimal            @db.Decimal(10, 2) // R50.00 or R100.00
  currency        String             @default("ZAR")
  startDate       DateTime
  endDate         DateTime
  autoRenew       Boolean            @default(true)
  maxInvoices     Int?               // 15 for STARTER, null for BUSINESS (unlimited)
  maxTeamMembers  Int?               // 1 for STARTER, 4 for BUSINESS
  yocoChargeId    String?            // Yoco payment reference
  cancelledAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

model Transaction {
  id              String            @id @default(uuid())
  walletId        String
  type            TransactionType
  status          TransactionStatus @default(PENDING)
  amount          Decimal           @db.Decimal(15, 2)
  fee             Decimal           @default(0) @db.Decimal(15, 2)
  netAmount       Decimal           @db.Decimal(15, 2)
  currency        String            @default("ZAR")
  reference       String?           @unique
  description     String?
  metadata        Json?
  processedAt     DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  wallet          Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  investment      Investment?       @relation(fields: [investmentId], references: [id])
  investmentId    String?
  revenuePayout   RevenuePayout?    @relation(fields: [revenuePayoutId], references: [id])
  revenuePayoutId String?

  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Business {
  id                  String     @id @default(uuid())
  userId              String
  registrationNumber  String     @unique
  tradingName         String
  legalName           String
  industry            String
  description         String     @db.Text
  website             String?
  founderName         String?
  founderTitle        String?    // CEO, Founder, Managing Director, etc.
  founderBio          String?    @db.Text
  teamSize            Int?
  yearFounded         Int?
  companyStory        String?    @db.Text
  address             String
  city                String
  province            String
  postalCode          String
  logo                String?
  bankName            String?
  bankAccountNumber   String?
  bankBranchCode      String?
  verified            Boolean    @default(false)
  verifiedAt          DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  user                User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  deals               Deal[]
  documents           BusinessDocument[]
  revenueConnections  RevenueConnection[]

  @@index([userId])
  @@index([registrationNumber])
}

model Deal {
  id                    String     @id @default(uuid())
  businessId            String
  title                 String
  description           String     @db.Text
  imageUrl              String?    // Deal card image
  fundingGoal           Decimal    @db.Decimal(15, 2)
  currentFunding        Decimal    @default(0) @db.Decimal(15, 2)
  minInvestment         Decimal    @default(100) @db.Decimal(15, 2)
  maxInvestment         Decimal?   @db.Decimal(15, 2)
  revenueSharePercentage Decimal   @db.Decimal(5, 2) // e.g., 5.00 for 5%
  repaymentCap          Decimal    @db.Decimal(5, 2) // e.g., 1.70 for 1.7x
  status                DealStatus @default(DRAFT)
  riskRating            Int        @default(5) // 1-10 scale
  fundingDeadline       DateTime
  startDate             DateTime?
  endDate               DateTime?
  
  // Business Metrics (from deal creation form)
  industry              String?
  location              String?
  monthlyRevenue        Decimal?   @db.Decimal(15, 2)
  revenueGrowth         Decimal?   @db.Decimal(5, 2) // Growth percentage
  riskLevel             String?    // Low, Medium, High
  foundedYear           Int?
  
  projectedMonthlyRevenue Decimal? @db.Decimal(15, 2)
  actualMonthlyRevenue  Decimal    @default(0) @db.Decimal(15, 2)
  totalRepaid           Decimal    @default(0) @db.Decimal(15, 2)
  investorCount         Int        @default(0)
  featuredImage         String?
  documents             Json?
  termsAndConditions    String     @db.Text
  adminNotes            String?    @db.Text
  approvedAt            DateTime?
  approvedBy            String?
  
  // Fund Release Requirements
  fundsHeld             Decimal    @default(0) @db.Decimal(15, 2) // Money held until docs verified
  fundsReleased         Decimal    @default(0) @db.Decimal(15, 2) // Money released to business
  documentsVerified     Boolean    @default(false) // Business submitted required docs
  bankDetailsVerified   Boolean    @default(false) // Bank account verified
  accountingSoftwareActive Boolean @default(false) // Must use Octrivium accounting
  canReceiveFunds       Boolean    @default(false) // All requirements met
  fundsReleasedAt       DateTime?  // When funds were released
  
  // Premium Listing Features
  isFeatured            Boolean    @default(false) // Featured badge on card
  isTopListing          Boolean    @default(false) // Top of homepage spot
  isSponsored           Boolean    @default(false) // Sponsored category placement
  isPrioritySearch      Boolean    @default(false) // Priority in search results
  isNewsletterFeatured  Boolean    @default(false) // Featured in investor newsletter
  isSocialBoosted       Boolean    @default(false) // Featured on social media
  isPriorityReview      Boolean    @default(false) // Fast-track approval
  premiumExpiresAt      DateTime?  // When premium features expire
  premiumNotes          String?    @db.Text // Admin notes about premium features
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  // Relations
  business              Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  investments           Investment[]
  revenueReports        RevenueReport[]
  revenuePayouts        RevenuePayout[]
  revenueRecords        RevenueRecord[]

  @@index([businessId])
  @@index([status])
  @@index([fundingDeadline])
}

model Investment {
  id                String    @id @default(uuid())
  userId            String
  dealId            String
  amount            Decimal   @db.Decimal(15, 2)
  sharePercentage   Decimal   @db.Decimal(10, 6) // Investor's % of total deal
  totalReceived     Decimal   @default(0) @db.Decimal(15, 2)
  expectedReturn    Decimal   @db.Decimal(15, 2) // amount * repaymentCap
  status            String    @default("PENDING") // PENDING, ACTIVE, COMPLETED, CANCELLED
  paymentMethod     String?   // YOCO, EFT, etc
  paymentToken      String?   // Yoco payment token
  paymentStatus     String    @default("PENDING") // PENDING, PAID, FAILED
  paidAt            DateTime?
  agreementSigned   Boolean   @default(false)
  agreementUrl      String?
  signedAt          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  transactions      Transaction[]
  payouts           InvestorPayout[]

  @@index([userId])
  @@index([dealId])
  @@index([status])
}

model RevenueReport {
  id                String    @id @default(uuid())
  dealId            String
  reportingMonth    DateTime  // First day of the month
  revenue           Decimal   @db.Decimal(15, 2)
  shareableAmount   Decimal   @db.Decimal(15, 2) // revenue * revenueSharePercentage
  supportingDocs    Json?
  verified          Boolean   @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  payout            RevenuePayout?

  @@unique([dealId, reportingMonth])
  @@index([dealId])
  @@index([reportingMonth])
}

model RevenuePayout {
  id                String    @id @default(uuid())
  dealId            String
  revenueReportId   String    @unique
  totalAmount       Decimal   @db.Decimal(15, 2)
  platformFee       Decimal   @db.Decimal(15, 2)
  netAmount         Decimal   @db.Decimal(15, 2)
  payoutMonth       DateTime
  status            String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  deal              Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  revenueReport     RevenueReport @relation(fields: [revenueReportId], references: [id], onDelete: Cascade)
  investorPayouts   InvestorPayout[]
  transactions      Transaction[]

  @@index([dealId])
  @@index([status])
  @@index([payoutMonth])
}

model InvestorPayout {
  id                String    @id @default(uuid())
  investmentId      String
  revenuePayoutId   String
  amount            Decimal   @db.Decimal(15, 2)
  status            String    @default("PENDING")
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  investment        Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  revenuePayout     RevenuePayout @relation(fields: [revenuePayoutId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([revenuePayoutId])
}

model KYCDocument {
  id            String    @id @default(uuid())
  userId        String
  documentType  String    // ID_DOCUMENT, PROOF_OF_ADDRESS, BANK_STATEMENT, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String?  @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentType])
}

model BusinessDocument {
  id            String    @id @default(uuid())
  businessId    String
  documentType  String    // REGISTRATION_CERT, TAX_CLEARANCE, FINANCIAL_STATEMENTS, etc.
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  verified      Boolean   @default(false)
  verifiedAt    DateTime?
  verifiedBy    String?
  rejectionReason String? @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([documentType])
}

model Notification {
  id            String    @id @default(uuid())
  userId        String
  type          String    // EMAIL, IN_APP, SMS
  category      String    // INVESTMENT, PAYOUT, KYC, DEAL_UPDATE, etc.
  title         String
  message       String    @db.Text
  metadata      Json?
  read          Boolean   @default(false)
  readAt        DateTime?
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  // Relations
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model AuditLog {
  id            String    @id @default(uuid())
  userId        String?
  action        String    // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity        String    // USER, DEAL, INVESTMENT, etc.
  entityId      String?
  changes       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime  @default(now())

  // Relations
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

// Revenue Verification System

model RevenueConnection {
  id                String              @id @default(uuid())
  businessId        String
  sourceType        RevenueSourceType
  provider          AccountingProvider? // Only for ACCOUNTING type
  
  // Connection Status
  isConnected       Boolean             @default(false)
  status            VerificationStatus  @default(PENDING)
  lastSyncAt        DateTime?
  lastSyncStatus    String?             // SUCCESS, FAILED, PARTIAL
  nextSyncAt        DateTime?
  
  // OAuth Tokens (encrypted)
  accessToken       String?             @db.Text
  refreshToken      String?             @db.Text
  tokenExpiresAt    DateTime?
  
  // Connection Metadata
  accountId         String?             // External account/org ID
  accountName       String?             // Bank name or accounting org name
  metadata          Json?               // Additional provider-specific data
  
  // Error Tracking
  lastError         String?             @db.Text
  errorCount        Int                 @default(0)
  
  connectedAt       DateTime?
  disconnectedAt    DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  business          Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bankAccounts      BankAccount[]
  revenueRecords    RevenueRecord[]
  verificationLogs  VerificationLog[]

  @@unique([businessId, sourceType])
  @@index([businessId])
  @@index([sourceType])
  @@index([status])
  @@index([lastSyncAt])
}

model BankAccount {
  id                  String            @id @default(uuid())
  connectionId        String
  
  // Bank Account Details
  accountId           String            // External bank account ID from Stitch
  accountName         String
  accountNumber       String?
  accountType         String?           // CURRENT, SAVINGS, CREDIT_CARD
  bankName            String
  currency            String            @default("ZAR")
  
  // Balance Info
  currentBalance      Decimal?          @db.Decimal(15, 2)
  availableBalance    Decimal?          @db.Decimal(15, 2)
  
  // Status
  isActive            Boolean           @default(true)
  lastTransactionDate DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  connection          RevenueConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactions        BankTransaction[]

  @@unique([connectionId, accountId])
  @@index([connectionId])
  @@index([accountId])
}

model BankTransaction {
  id                String      @id @default(uuid())
  bankAccountId     String
  
  // Transaction Details
  transactionId     String      // External transaction ID
  date              DateTime
  description       String
  amount            Decimal     @db.Decimal(15, 2)
  balance           Decimal?    @db.Decimal(15, 2)
  category          String?
  reference         String?
  
  // Classification
  isRevenue         Boolean     @default(false)
  isExpense         Boolean     @default(false)
  isTransfer        Boolean     @default(false)
  
  metadata          Json?
  createdAt         DateTime    @default(now())

  // Relations
  bankAccount       BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@unique([bankAccountId, transactionId])
  @@index([bankAccountId])
  @@index([date])
  @@index([isRevenue])
}

model RevenueRecord {
  id                  String              @id @default(uuid())
  dealId              String
  connectionId        String
  
  // Period
  month               DateTime            // First day of month
  year                Int
  
  // Revenue Data
  totalRevenue        Decimal             @db.Decimal(15, 2)
  verifiedRevenue     Decimal?            @db.Decimal(15, 2)
  revenueShareAmount  Decimal             @db.Decimal(15, 2) // Amount owed to investors
  
  // Source Info
  sourceType          RevenueSourceType
  sourceData          Json?               // Raw data from source
  
  // Verification
  status              VerificationStatus  @default(PENDING)
  verifiedAt          DateTime?
  verifiedBy          String?             // Admin user ID
  
  // Discrepancy Detection
  hasDiscrepancy      Boolean             @default(false)
  discrepancyAmount   Decimal?            @db.Decimal(15, 2)
  discrepancyNotes    String?             @db.Text
  
  // Payout Status
  payoutScheduled     Boolean             @default(false)
  payoutCompletedAt   DateTime?
  
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  deal                Deal                @relation(fields: [dealId], references: [id], onDelete: Cascade)
  connection          RevenueConnection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([dealId, connectionId, month])
  @@index([dealId])
  @@index([connectionId])
  @@index([month])
  @@index([status])
}

model VerificationLog {
  id                String            @id @default(uuid())
  connectionId      String
  
  // Verification Details
  verificationType  String            // BANK_SYNC, ACCOUNTING_SYNC, CROSS_REFERENCE, FRAUD_CHECK
  status            String            // SUCCESS, FAILED, WARNING
  
  // Data
  dataFetched       Json?
  discrepancies     Json?
  
  // Results
  message           String?           @db.Text
  errorDetails      String?           @db.Text
  
  // Metadata
  duration          Int?              // Sync duration in ms
  recordsProcessed  Int?
  recordsFailed     Int?
  
  createdAt         DateTime          @default(now())

  // Relations
  connection        RevenueConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([verificationType])
  @@index([status])
  @@index([createdAt])
}

model ManualUpload {
  id                String            @id @default(uuid())
  businessId        String
  dealId            String?
  
  // File Details
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  
  // Upload Type
  uploadType        String            // BANK_STATEMENT, ACCOUNTING_REPORT, INVOICE_EXPORT
  month             DateTime          // Period this upload covers
  
  // Extracted Data
  extractedRevenue  Decimal?          @db.Decimal(15, 2)
  extractedData     Json?
  
  // Verification
  status            VerificationStatus @default(PENDING)
  verifiedAt        DateTime?
  verifiedBy        String?
  rejectionReason   String?           @db.Text
  
  // Notes
  businessNotes     String?           @db.Text
  adminNotes        String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([businessId])
  @@index([dealId])
  @@index([month])
  @@index([status])
}

model PayoutSchedule {
  id                String            @id @default(uuid())
  dealId            String
  month             DateTime          // Payment month
  
  // Amounts
  totalRevenue      Decimal           @db.Decimal(15, 2)
  revenueShareAmount Decimal          @db.Decimal(15, 2)
  platformFee       Decimal           @db.Decimal(15, 2)
  netPayoutAmount   Decimal           @db.Decimal(15, 2)
  
  // Status
  status            String            @default("SCHEDULED") // SCHEDULED, PROCESSING, COMPLETED, FAILED, PAUSED
  scheduledDate     DateTime
  processedDate     DateTime?
  
  // Flags
  isPaused          Boolean           @default(false)
  pauseReason       String?           @db.Text
  
  // References
  revenueRecordIds  Json              // Array of RevenueRecord IDs used
  
  // Metadata
  investorCount     Int?
  metadata          Json?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([dealId, month])
  @@index([dealId])
  @@index([month])
  @@index([status])
  @@index([scheduledDate])
}

// ============================================
// ACCOUNTING SYSTEM MODELS
// ============================================

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum ExpenseCategory {
  ADVERTISING
  BANK_FEES
  OFFICE_SUPPLIES
  RENT
  UTILITIES
  TRAVEL
  MEALS
  PROFESSIONAL_SERVICES
  SOFTWARE
  INSURANCE
  TAXES
  PAYROLL
  OTHER
}

enum RecurringType {
  MONTHLY
  ANNUALLY
  CUSTOM
}

enum TransactionCategory {
  INCOME
  EXPENSE
  TRANSFER
}

model Customer {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Customer Details
  name              String
  email             String?
  phone             String?
  company           String?            // Company name
  companyEmail      String?            // Business email
  companyPhone      String?            // Business phone
  website           String?            // Company website
  
  // Address
  addressLine1      String?
  addressLine2      String?
  city              String?
  province          String?
  postalCode        String?
  country           String            @default("South Africa")
  
  // Financial & Registration
  vatNumber         String?            // VAT/Tax number
  registrationNumber String?           // Business registration number
  
  // Relations
  invoices          Invoice[]
  recurringInvoices RecurringInvoice[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([email])
}

model Invoice {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId        String?
  customer          Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Invoice Details
  invoiceNumber     String            @unique
  status            InvoiceStatus     @default(DRAFT)
  documentType      String            @default("INVOICE") // INVOICE or QUOTE
  includeVat        Boolean           @default(true)
  
  // Dates
  issueDate         DateTime          @default(now())
  dueDate           DateTime
  paidDate          DateTime?
  
  // Amounts
  subtotal          Decimal           @db.Decimal(15, 2)
  taxRate           Decimal           @db.Decimal(5, 2) @default(15.00) // VAT 15%
  taxAmount         Decimal           @db.Decimal(15, 2)
  total             Decimal           @db.Decimal(15, 2)
  amountPaid        Decimal           @db.Decimal(15, 2) @default(0.00)
  amountDue         Decimal           @db.Decimal(15, 2)
  
  // Content
  notes             String?           @db.Text
  terms             String?           @db.Text
  
  // Payment
  paymentLink       String?           @unique
  
  // Signature
  requiresSignature Boolean           @default(false)
  signatureData     String?           @db.Text
  signedAt          DateTime?
  signerName        String?
  
  // Template
  templateId        Int               @default(1) // 1-10 for different designs
  
  // Relations
  items             InvoiceItem[]
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@index([paymentLink])
}

model InvoiceItem {
  id                String            @id @default(uuid())
  invoiceId         String
  invoice           Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Item Details
  description       String
  quantity          Decimal           @db.Decimal(10, 2)
  unitPrice         Decimal           @db.Decimal(15, 2)
  costPrice         Decimal?          @db.Decimal(15, 2) // Cost to business
  total             Decimal           @db.Decimal(15, 2)
  profit            Decimal?          @db.Decimal(15, 2) // Calculated profit
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([invoiceId])
}

model Expense {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Expense Details
  description       String
  category          ExpenseCategory
  amount            Decimal           @db.Decimal(15, 2)
  date              DateTime          @default(now())
  
  // Vendor
  vendor            String?
  
  // Receipt
  receiptUrl        String?
  
  // Tax
  taxAmount         Decimal?          @db.Decimal(15, 2)
  taxDeductible     Boolean           @default(true)
  
  // Recurring Settings
  isRecurring       Boolean           @default(false)
  recurringType     RecurringType?    // MONTHLY, ANNUALLY, CUSTOM
  recurringInterval Int?              // For custom intervals (e.g., 13 months)
  nextDueDate       DateTime?
  
  // Notes
  notes             String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([category])
  @@index([date])
}

model AccountingTransaction {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Transaction Details
  date              DateTime          @default(now())
  description       String
  category          TransactionCategory
  amount            Decimal           @db.Decimal(15, 2)
  
  // Bank Details (from Stitch integration)
  bankTransactionId String?           @unique
  bankName          String?
  accountNumber     String?
  
  // Reconciliation
  isReconciled      Boolean           @default(false)
  reconciledDate    DateTime?
  invoiceId         String?
  expenseId         String?
  
  // Notes
  notes             String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([date])
  @@index([category])
  @@index([isReconciled])
}

model ChartOfAccounts {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Account Details
  code              String
  name              String
  type              String            // ASSET, LIABILITY, EQUITY, INCOME, EXPENSE
  
  // Status
  isActive          Boolean           @default(true)
  
  // Description
  description       String?           @db.Text
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([userId, code])
  @@index([userId])
  @@index([type])
}

model Product {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Product Details
  name              String
  description       String?
  unitPrice         Decimal           @db.Decimal(15, 2)
  costPrice         Decimal?          @db.Decimal(15, 2)
  category          String?
  sku               String?
  
  // Tax
  taxable           Boolean           @default(true)
  
  // Status
  active            Boolean           @default(true)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([active])
}

model RecurringInvoice {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId        String
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Template Details
  invoicePrefix     String            @default("INV")
  
  // Recurrence Settings
  frequency         RecurringType     // MONTHLY, ANNUALLY, CUSTOM
  interval          Int               @default(1) // Every X months/years
  dayOfMonth        Int?              // For monthly (1-31)
  startDate         DateTime
  endDate           DateTime?         // Optional end date
  nextInvoiceDate   DateTime
  
  // Invoice Content
  items             Json              // Array of invoice items
  subtotal          Decimal           @db.Decimal(15, 2)
  taxRate           Decimal           @db.Decimal(5, 2) @default(15.00)
  taxAmount         Decimal           @db.Decimal(15, 2)
  total             Decimal           @db.Decimal(15, 2)
  
  // Terms
  paymentTermsDays  Int               @default(30)
  notes             String?           @db.Text
  terms             String?           @db.Text
  
  // Status
  active            Boolean           @default(true)
  lastGeneratedAt   DateTime?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([userId])
  @@index([customerId])
  @@index([active])
  @@index([nextInvoiceDate])
}

model Email {
  id              String    @id @default(uuid())
  
  // Email metadata
  messageId       String    @unique // Resend message ID or email Message-ID header
  threadId        String?   // Group emails in conversations
  subject         String
  fromEmail       String
  fromName        String?
  toEmail         String
  toName          String?
  ccEmails        String[]  @default([])
  bccEmails       String[]  @default([])
  replyTo         String?
  
  // Content
  htmlBody        String?   @db.Text
  textBody        String?   @db.Text
  attachments     Json?     // Array of {filename, url, size, contentType}
  
  // Status
  isRead          Boolean   @default(false)
  isStarred       Boolean   @default(false)
  isArchived      Boolean   @default(false)
  isDeleted       Boolean   @default(false)
  isSent          Boolean   @default(false) // true if sent by user, false if received
  
  // Spam/Folder management
  folder          String    @default("inbox") // inbox, sent, drafts, spam, trash
  spamScore       Float?
  
  // Relations
  senderId        String?   // User who sent this email
  sender          User?     @relation("SentEmails", fields: [senderId], references: [id], onDelete: SetNull)
  
  receiverId      String?   // User who received this email
  receiver        User?     @relation("ReceivedEmails", fields: [receiverId], references: [id], onDelete: SetNull)
  
  // Timestamps
  sentAt          DateTime  @default(now())
  receivedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([threadId])
  @@index([folder])
  @@index([isDeleted])
  @@index([sentAt])
}
